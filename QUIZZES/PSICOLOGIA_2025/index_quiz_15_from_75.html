<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Quiz: 15 domande casuali da pool di 75</title>
<style>
body{font-family:Arial, sans-serif; background:#f6f8fb; color:#111}
.container{max-width:900px;margin:24px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.06)}
h1{font-size:20px;margin:0 0 8px}
.question{padding:12px;border-radius:6px;margin:12px 0;border:1px solid #e6eef7;background:#fbfeff}
.option{display:block;margin:6px 0}
.correct{background:#e6ffed}
.incorrect{background:#fff2f2}
.controls{margin-top:12px}
button{background:#0b66ff;color:#fff;padding:10px 14px;border:none;border-radius:6px;cursor:pointer}
small.note{color:#666}
</style>
</head>
<body>
<div class="container">
  <h1>Quiz casuale â€” 15 domande.</h1>
  <div class="note small">Le risposte corrette verranno sempre mostrate dopo la valutazione.</div>
  <div id="quiz"></div>
  <div class="controls">
    <button id="btnSubmit">Valuta quiz</button>
    <button id="btnReset" style="background:#888;margin-left:10px">Reset</button>
    <div id="result" style="margin-top:10px"></div>
  </div>
</div>

<script>
async function loadPool() {
  const res = await fetch('questions_pool_75.json');
  if (!res.ok) throw new Error('Impossibile caricare questions_pool_75.json');
  return res.json();
}

function sampleWithCoverage(pool, sampleSize=15) {
  const byTopic = {};
  pool.forEach(q=>{
    const t = q.topic || 'Altro';
    if (!byTopic[t]) byTopic[t]=[];
    byTopic[t].push(q);
  });
  const topics = Object.keys(byTopic);
  const chosen = [];
  for(const t of topics){
    if (chosen.length >= sampleSize) break;
    const arr = byTopic[t];
    if (arr && arr.length>0) {
      const idx = Math.floor(Math.random()*arr.length);
      chosen.push(arr[idx]);
      byTopic[t].splice(idx,1);
    }
  }
  const remaining = [];
  for(const t of Object.keys(byTopic)) byTopic[t].forEach(q=>remaining.push(q));
  while(chosen.length < sampleSize && remaining.length>0){
    const idx = Math.floor(Math.random()*remaining.length);
    chosen.push(remaining[idx]);
    remaining.splice(idx,1);
  }
  for(let i=chosen.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [chosen[i],chosen[j]]=[chosen[j],chosen[i]];
  }
  return chosen;
}

function renderQuiz(questions) {
  const container = document.getElementById('quiz');
  container.innerHTML='';
  questions.forEach((q, idx) => {
    const div = document.createElement('div');
    div.className='question';
    div.id = 'q'+idx;
    let html = `<div><strong>${idx+1})</strong> ${escapeHtml(q.question)}</div>`;
    html += '<div>';
    q.options.forEach((opt, i) => {
      html += `<label class="option"><input type="radio" name="q${idx}" value="${i}"> <strong>${String.fromCharCode(65+i)}.</strong> ${escapeHtml(opt)}</label>`;
    });
    html += '</div>';
    div.innerHTML = html;
    div.dataset.correct = q.correct;
    container.appendChild(div);
  });
}

function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function evaluate(questions) {
  let correctCount = 0;
  questions.forEach((q, idx) => {
    const sel = document.querySelector(`input[name="q${idx}"]:checked`);
    const div = document.getElementById('q'+idx);
    const correctIndex = parseInt(div.dataset.correct);
    div.classList.remove('correct','incorrect');
    let expl = div.querySelector('.explanation');
    if (!expl) { expl = document.createElement('div'); expl.className='explanation'; div.appendChild(expl); }
    if (!sel) {
      div.classList.add('incorrect');
      expl.innerHTML = `<em>Risposta corretta: ${String.fromCharCode(65+correctIndex)}.</em> ${escapeHtml(q.options[correctIndex])}`;
    } else {
      const chosen = parseInt(sel.value);
      if (chosen === correctIndex) {
        correctCount++;
        div.classList.add('correct');
      } else {
        div.classList.add('incorrect');
      }
      expl.innerHTML = `<em>Risposta corretta: ${String.fromCharCode(65+correctIndex)}.</em> ${escapeHtml(q.options[correctIndex])}`;
    }
  });
  return correctCount;
}

let currentQuestions = [];
loadPool().then(pool=>{
  const sel = sampleWithCoverage(pool, 15);
  currentQuestions = sel;
  renderQuiz(sel);
}).catch(err=>{
  document.getElementById('quiz').innerHTML = '<div style="color:#b00">Errore caricamento pool: '+err.message+'</div>';
});

document.getElementById('btnSubmit').addEventListener('click', function(){
  const score = evaluate(currentQuestions);
  document.getElementById('result').innerHTML = `<div>Hai ottenuto ${score} risposte corrette su ${currentQuestions.length} (${Math.round(score/currentQuestions.length*100)}%).</div>`;
  window.scrollTo({top:document.getElementById('result').offsetTop-20, behavior:'smooth'});
});
document.getElementById('btnReset').addEventListener('click', function(){
  loadPool().then(pool=>{
    const sel = sampleWithCoverage(pool,15);
    currentQuestions = sel;
    renderQuiz(sel);
    document.getElementById('result').innerHTML = '';
  });
});
</script>
</body>
</html>
